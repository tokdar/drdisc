---
title: "report24"
author: "Haoliang Zheng"
date: "6/1/2021"
output:
  pdf_document
---

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = "/Users/zhl/Desktop/drdisc")
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.align = 'center', 
                      fig.width=6, fig.height=7)

library(abind)
library(knitr)
library(latex2exp)
require(magrittr)
require(plyr)
library(tidyverse)
library(coda)
library(doParallel)
library(doMC) 
library(foreach)
library(doRNG)
library(gridExtra)

adapt <- FALSE
bunch <- FALSE
N_para <- 6

registerDoMC(6)
```


```{r source, include=FALSE}
source("./codes/new-codes.R")
source("./codes/test-codes.R")
source("./codes/other-codes.R")

multi_chain_coda_noa <- function(result_multi, burn = 1000, N_para, p, order){
  coda_result <- list()
  matrix_result <- NULL
  for(i in 1:N_para){
    matrix_result <- NULL
    for(j in 1:order){
      for(k in 1:p){
        bijk <- matrix(result_multi[[i]]$b[j,k,], ncol = 1)
        colnames(bijk) <- paste0("b",j,k)
        matrix_result <- cbind(matrix_result, bijk)
      }
    }
    coda_result[[i]] <- mcmc(matrix_result, start = burn+1)
  }
  coda_result_list <- mcmc.list(coda_result)
  
  return(coda_result_list)
}
```

# simulated data, order = 2

```{r}
N_para <- 6
simulate <- TRUE
## Density regression with jump
if(simulate){
  set.seed(123)
  p <- 2
  n.obs <- 6e4
  b0x <- cbind(b0, threshold(rt(order, df=6),1))
  while(ncol(b0x) < p) b0x <- cbind(b0x, 0)
  a0 <- c(1, 4, rep(0,p-2))
  shapes0 <- c(4,1)
  pers0 <- 1/2
  jbw0 <- 0.16*2*pers0
  pos.synth <- TRUE
  pos.est <- TRUE
  
  x.obs <- cbind(1, matrix(rnorm(n.obs*(p-1)), n.obs, p-1))
  y.obs <- simulate.fx(n.obs, b0x, x.obs, a0, shapes0, jbw0, positive=pos.synth)
}

N_para <- 6
set.seed(123)
b_init <- replicate(N_para, matrix(rnorm(n = order*p, sd = 3), order, p))
a_init <- replicate(N_para, rnorm(n = p, sd = 3))
```

```{r}
hist(y.obs)
```


# no trimming

```{r}
set.seed(123)
order <- 2
b_init <- replicate(N_para, matrix(rnorm(n = order*p, sd=1), order, p))
a_init <- replicate(N_para, rnorm(n = p, sd = 1.5))
```

```{r ,eval=FALSE}
sim_notrim_order2 <- foreach(i = 1:N_para) %dorng%
  bdregjump_adapt_poly_trim_alphanoPG(y=y.obs, x=x.obs,
                                      b=b_init[,,i], burn=15000, nsamp=10000,
                                      thin=1, trim = 1, order = 2,
                                      jump=list(a=a_init[,i], prec = 1, positive=pos.est,
                                                persistence=0.5, update.jbw=TRUE))
```

```{r}
load("./report/report24/sim_notrim_order2.RData")
```

```{r}
sim_notrim_order2[[1]]$shapes[,10000]
```

```{r r1, cache=TRUE}
sim_notrim_order2_coda <- multi_chain_coda(sim_notrim_order2,
                                           burn = 15000, N_para, p, order = 2)
```


```{r}
get.result.bdregjump(sim_notrim_order2[[1]], x.obs, y.obs, b0x, a0)
```


# trimming = 0.5

```{r}
trim05_ind <- (abs(y.obs) < 0.5)
sim_data_trim05_y <- y.obs[trim05_ind]
sim_data_trim05_x <- x.obs[trim05_ind,]
```

```{r}
hist(sim_data_trim05_y)
```


```{r ,eval=FALSE}
i <- 1
sim_trim05_order2_i1_shapeadapt22 <- bdregjump_adapt_poly_trim_alphanoPG_shapeadapt(y=sim_data_trim05_y, x=sim_data_trim05_x,b=b_init[,,i], burn=15000, nsamp=10000,thin=1, trim = 0.5,
order = 2,jump=list(a=a_init[,i], prec = 1, positive=pos.est,persistence=0.5, update.jbw=TRUE),
print.process = TRUE)
```

```{r}
load("./report/report24/sim_trim05_order2_i1_shapeadapt22.RData")
```

```{r}
sim_trim05_order2_i1_shapeadapt22$shapes[,10000]
```


```{r}
set.seed(123)
get.result.bdregjump(sim_trim05_order2_i1_shapeadapt22, 
                     sim_data_trim05_x, sim_data_trim05_y, b0x, a0,
                     trim=0.5)
```
